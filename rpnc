#!/usr/bin/perl

#   Sinn: Commandline-Pocketcalculator
#  Autor: t3o 2023++

# DONE change the parser to read char by char in a mode like "number" or "string"
# DONE we need types of things on the stack
# TODO inv
# TODO ^
# TODO do we need 3 over (ovr) ? or "<n> copy"?
# DONE: Parser ändern, dass er zeichenweise liest, dabei in einem Modus wie zb "zahl" ist, oder "string"
# DONE brauchen (eigentlich) Typen für Dinge auf dem Stack (das koennte ein Package sein)

# TODO: Programmierfähigkeit -- unter einem Namen eine zu parsende Zeichenkette ablegen
# TODO: Hilfe einbauen
# TODO konstanten
#
use constant REVISION => "20231213";

use strict;
use warnings;
use Data::Dumper;
use Getopt::Long;
use YAML::Syck;
use Test::More;
use Test::Exception;
use FindBin;
use lib "$FindBin::Bin";
use Parser;
use TheMachine;

$|=1;
$Data::Dumper::Sortkeys = 1;

GetOptions(
	'help|h' => \my $need_help,
	'test' => \my $do_tests,
	'nosave' => \my $nosave,         # default: false
	'noload' => \my $noload,         # default: false
	'statefile=s' => \my $statefile, # default: HOME/.rpnc
	# 'quiet'  => \my $be_quiet,
);
usage() if $need_help;
if ($do_tests)
{
	note("--+- performing tests -+--");
	# test__is_allowed_system_name();
	is_deeply( Parser::next_atom("54321"), [{type => Parser->NUMBER, value => "54321"}, ""], "Parser::next_atom" );
	is_deeply( Parser::next_atom("3.14159"), [{type => Parser->NUMBER, value => "3.14159"}, ""], "Parser::next_atom" );
	is_deeply( Parser::next_atom("5+"), [{type => Parser->NUMBER, value => "5"}, "+"], "Parser::next_atom" );

	my $s = "3.6 1.8/";
	my $r = Parser::next_atom( $s );
	is_deeply( $r, [{type => Parser->NUMBER, value => "3.6"}, " 1.8/"], "Parser::next_atom $s" );

	$s = $r->[1];
	$r = Parser::next_atom( $s );
	is_deeply( $r, [{type => Parser->NUMBER, value => "1.8"}, "/"], "Parser::next_atom $s" );

	$s = $r->[1];
	$r = Parser::next_atom( $s );
	is_deeply( $r, [{type => Parser->OPERATOR, value => "/"}, ""], "Parser::next_atom $s" );

	$s = $r->[1]; # Expected end
	$r = Parser::next_atom( $s );
	is_deeply( $r, [{type => Parser->END_OF_STREAM, value => "moo"}, ""], "END_OF_STREAM" );

	is_deeply( Parser::next_atom("clear5+"), [{type => Parser->OPERATOR, value => "clear"}, "5+"], "Parser::next_atom / clear" );
	is_deeply( Parser::next_atom("clr6+")  , [{type => Parser->OPERATOR, value => "clr"}, "6+"], "Parser::next_atom / clear" );
	is_deeply( Parser::next_atom("fahrenheit")  , [{type => Parser->SYMBOL, value => "fahrenheit"}, ""], "Parser::next_atom / symbol" );
	is_deeply( Parser::next_atom("fahrenheit*")  , [{type => Parser->SYMBOL, value => "fahrenheit"}, "*"], "Parser::next_atom / symbol" );

	done_testing;
	exit(0);
}
Test::More->builder->reset;

print "Welcome to the wunderful world of R-P-N-C\n";
my $rpnc = TheMachine->new(
	nosave => $nosave,
	noload => $noload,
	statefile => $statefile,
);
my $loop = 434;
while ($loop)
{
	$rpnc->show();
	my $input = <STDIN>;
	unless (defined $input) # Ctrl-d
	{
		print "\n";
		last;
	}
	chomp($input);

	my $atom;
	while(434)
	{
		my $thingy = Parser::next_atom( $input );
		$atom  = $thingy->[0];
		$input = $thingy->[1];
		# print " DEBUGGING atom from stream: " . Dumper($atom);
		my $type = $atom->{ type };
		last if $type eq Parser->END_OF_STREAM;
		if (($type eq Parser->OPERATOR) && ($atom->{value} eq "q")) # quit
		{
			$loop = 0;
			last;
		}
		else {
			$rpnc->do( $atom ); # handle NUMBER OPERATOR
		}
	}
}
$rpnc->shutdown();
exit(0);

# ----------------------------------------------------------------------------
sub usage
{
	my $msg = shift;
	print "$0 REVISION " . REVISION . "\n";
	print "ERROR: $msg\n" if defined $msg;
	print "Usage: $0 ....\n";
	exit(1);
}

